@using SonicWave8D.Models
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="@GetCardClasses()">

    <!-- Hidden Audio Element -->
    <audio @ref="audioRef"
           id="@audioElementId"
           src="@activeUrl"
           @onended="OnAudioEnded"
           @onloadedmetadata="OnLoadedMetadata"
           @onloadeddata="OnLoadedData"></audio>

    <!-- Main Row -->
    <div class="p-4 flex flex-col gap-4">

        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-4 min-w-0 flex-grow">
                <!-- Play Button -->
                <div class="relative">
                    <button @onclick="TogglePlay"
                            class="@GetPlayButtonClasses()">
                        @if (Track.Status == TrackStatus.Processing)
                        {
                            <svg class="w-6 h-6 animate-spin text-white/50" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                            </svg>
                        }
                        else if (isPlaying)
                        {
                            <svg class="w-6 h-6 fill-current" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="6" y="4" width="4" height="16"/>
                                <rect x="14" y="4" width="4" height="16"/>
                            </svg>
                        }
                        else
                        {
                            <svg class="w-6 h-6 fill-current ml-1" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="5 3 19 12 5 21 5 3"/>
                            </svg>
                        }
                    </button>

                    <!-- Status Badge -->
                    @if (Track.Status == TrackStatus.Completed)
                    {
                        <div class="@GetStatusBadgeClasses()">
                            @(isComparing ? "Orig" : "8D")
                        </div>
                    }
                </div>

                <!-- Info -->
                <div class="min-w-0 flex-grow space-y-1">
                    <h4 class="@GetTitleClasses()" title="@Track.OriginalName">
                        @Track.OriginalName
                    </h4>
                    <div class="flex items-center gap-2 text-xs text-slate-400">
                        <span>@Track.UploadDate.ToString("h:mm tt")</span>
                        <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                        <span class="uppercase">@GetFileExtension()</span>

                        @if (Track.Status == TrackStatus.Completed)
                        {
                            <span class="w-1 h-1 rounded-full bg-slate-600"></span>
                            <span class="@(Track.Is8dEnabled ? "text-pink-400" : "text-blue-400")">
                                @(Track.Is8dEnabled ? "8D Spatial" : "Standard EQ")
                            </span>
                        }
                    </div>
                </div>
            </div>

            <!-- Actions / Controls -->
            <div class="flex items-center gap-2">

                <!-- Configuration Controls (Visible for Pending AND Completed) -->
                @if (IsConfigurable())
                {
                    <!-- 8D Toggle -->
                    <button @onclick="() => OnToggle8D.InvokeAsync((Track.Id, !Track.Is8dEnabled))"
                            class="@Get8DToggleClasses()">
                        <div class="@(Track.Is8dEnabled ? "bg-pink-500" : "bg-slate-600") w-2 h-2 rounded-full"></div>
                        <span class="hidden sm:inline">8D</span>
                    </button>

                    <!-- Preset Selector -->
                    <div class="flex items-center gap-2 bg-slate-900 rounded-lg px-3 py-1.5 border border-slate-700">
                        <svg class="w-3.5 h-3.5 text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="21" y1="4" x2="14" y2="4"/>
                            <line x1="10" y1="4" x2="3" y2="4"/>
                            <line x1="21" y1="12" x2="12" y2="12"/>
                            <line x1="8" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="20" x2="16" y2="20"/>
                            <line x1="12" y1="20" x2="3" y2="20"/>
                            <line x1="14" y1="2" x2="14" y2="6"/>
                            <line x1="8" y1="10" x2="8" y2="14"/>
                            <line x1="16" y1="18" x2="16" y2="22"/>
                        </svg>
                        <select @bind="Track.SelectedPresetId"
                                @bind:after="HandlePresetChanged"
                                class="bg-transparent text-xs text-slate-300 outline-none border-none cursor-pointer w-20 sm:w-28">
                            @foreach (var preset in AudioConstants.EQ_PRESETS.Where(p => p.Id != "custom"))
                            {
                                <option value="@preset.Id">@preset.Name</option>
                            }
                            @if (Track.SelectedPresetId == "custom")
                            {
                                <option value="custom">Custom</option>
                            }
                        </select>
                    </div>

                    <!-- EQ Expand Toggle -->
                    <button @onclick="() => isEqExpanded = !isEqExpanded"
                            class="@GetEqExpandClasses()"
                            title="Toggle EQ Sliders">
                        @if (isEqExpanded)
                        {
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="18 15 12 9 6 15"/>
                            </svg>
                        }
                        else
                        {
                            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        }
                    </button>
                }

                <!-- Pending Only: Process Button -->
                @if (Track.Status == TrackStatus.Pending)
                {
                    <button @onclick="() => OnProcess.InvokeAsync(Track.Id)"
                            class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-medium rounded-lg transition-colors shadow-lg shadow-indigo-900/20">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                        <span class="hidden sm:inline">Process</span>
                    </button>
                }

                <!-- Processing Indicator -->
                @if (Track.Status == TrackStatus.Processing)
                {
                    <span class="text-xs text-indigo-300 animate-pulse px-3">Processing...</span>
                }

                <!-- Completed Actions -->
                @if (Track.Status == TrackStatus.Completed && !string.IsNullOrEmpty(Track.ProcessedDataUrl))
                {
                    <!-- Compare Toggle -->
                    <button @onclick="() => isComparing = !isComparing"
                            class="@GetCompareButtonClasses()"
                            title="Compare with Original">
                        <svg class="w-4 h-4 sm:mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 8.5a6.5 6.5 0 1 1 13 0c0 6-6 6-6 10a3.5 3.5 0 1 1-7 0"/>
                            <path d="M15 8.5a2.5 2.5 0 0 0-5 0v1a2 2 0 1 1 0 4"/>
                        </svg>
                        <span class="hidden sm:inline">@(isComparing ? "Orig" : "Compare")</span>
                    </button>

                    <!-- Regenerate Button -->
                    <button @onclick="() => OnProcess.InvokeAsync(Track.Id)"
                            class="p-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg transition-colors shadow-lg shadow-indigo-900/20"
                            title="Regenerate with current settings">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                            <path d="M3 3v5h5"/>
                            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
                            <path d="M16 16h5v5"/>
                        </svg>
                    </button>

                    <!-- Download -->
                    <a href="@Track.ProcessedDataUrl"
                       download="@GetDownloadFileName()"
                       class="p-2 bg-slate-700 hover:bg-emerald-600 text-slate-300 hover:text-white rounded-lg transition-colors border border-slate-600"
                       title="Download WAV">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                    </a>

                    <!-- Delete -->
                    <button @onclick="() => OnDelete.InvokeAsync(Track.Id)"
                            class="p-2 text-slate-600 hover:text-red-400 transition-colors"
                            title="Delete Track">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"/>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            <line x1="10" y1="11" x2="10" y2="17"/>
                            <line x1="14" y1="11" x2="14" y2="17"/>
                        </svg>
                    </button>
                }

                @if (Track.Status == TrackStatus.Error)
                {
                    <span class="text-red-400 text-xs">Error Processing</span>
                }
            </div>
        </div>

        <!-- Custom Progress Bar -->
        @if ((Track.Status == TrackStatus.Completed || isPlaying) && duration > 0)
        {
            <div class="flex items-center gap-3 px-1">
                <span class="text-[10px] text-slate-400 w-8 text-right font-mono">@FormatTime(currentTime)</span>

                <div @onclick="HandleSeek"
                     @ref="progressBarRef"
                     class="flex-grow h-1.5 bg-slate-700 rounded-full cursor-pointer relative group">

                    <!-- Background Track -->
                    <div class="absolute inset-0 rounded-full overflow-hidden">
                        <!-- Progress Fill -->
                            <div class="@GetProgressBarClasses() h-full transition-all duration-100"
                                 style="width: @(progress.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%"></div>
                    </div>

                    <!-- Moving Thumb (visible during playback) -->
                    <div class="@(isPlaying ? "opacity-100" : "opacity-0 group-hover:opacity-100") absolute top-1/2 -translate-y-1/2 w-3 h-3 bg-white rounded-full shadow-lg transition-opacity"
                         style="left: @(progress.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%; margin-left: -6px"></div>
                </div>

                <span class="text-[10px] text-slate-400 w-8 font-mono">@FormatTime(duration)</span>
            </div>
        }

    </div>

    <!-- Manual EQ Section -->
    @if (isEqExpanded && IsConfigurable())
    {
        <div class="px-6 pb-6 pt-2 border-t border-slate-700/50 bg-slate-900/30 animate-fade-in-down">
            <div class="flex justify-between items-center mb-6">
                <h5 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Frequency Response</h5>
                <button @onclick="HandleResetEQ"
                        class="text-[10px] text-indigo-400 hover:text-indigo-300">
                    Reset
                </button>
            </div>

            <div class="grid grid-cols-10 gap-3 sm:gap-4 h-44 items-end py-4">
                @for (int i = 0; i < Track.CurrentGains.Count; i++)
                {
                    var index = i;
                    var gain = Track.CurrentGains[i];
                    <div class="flex flex-col items-center justify-end h-full group relative">
                        <!-- Tooltip -->
                        <div class="absolute -top-10 left-1/2 -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-all duration-200 bg-slate-900 text-white text-xs px-3 py-1.5 rounded-lg border border-slate-700 pointer-events-none whitespace-nowrap z-20 shadow-xl">
                            <div class="font-semibold">@((gain > 0 ? "+" : "") + gain.ToString("F0")) dB</div>
                            <div class="text-[10px] text-slate-400">@FormatFrequency(AudioConstants.EQ_FREQUENCIES[index])Hz</div>
                        </div>

                        <!-- Slider container with visual track -->
                        <div class="flex-1 w-full flex items-center justify-center relative px-2" style="min-height: 140px;">
                            <!-- Center line indicator -->
                            <div class="absolute w-full h-0.5 bg-slate-600/50 top-1/2 -translate-y-1/2 pointer-events-none rounded-full"></div>

                            <!-- Vertical range input -->
                            <input type="range"
                                   min="-20"
                                   max="20"
                                   step="1"
                                   value="@gain"
                                   @oninput="e => HandleGainInput(index, e)"
                                   class="eq-slider"
                                   style="width: 150px; height: 8px; transform: rotate(-90deg); transform-origin: center center; border-radius: 4px; background: @GetSliderBackground(gain); position: absolute;" />
                        </div>

                        <!-- Frequency label -->
                        <div class="text-center mt-2 flex-shrink-0">
                            <span class="text-[10px] text-slate-400 font-mono block font-medium">@FormatFrequency(AudioConstants.EQ_FREQUENCIES[index])</span>
                            <span class="text-[8px] text-slate-600 block">@((gain > 0 ? "+" : "") + gain.ToString("F0"))</span>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public AudioTrack Track { get; set; } = null!;

    [Parameter]
    public EventCallback<string> OnProcess { get; set; }

    [Parameter]
    public EventCallback<string> OnDelete { get; set; }

    [Parameter]
    public EventCallback<(string trackId, string presetId)> OnPresetChange { get; set; }

    [Parameter]
    public EventCallback<(string trackId, int index, double value)> OnGainChange { get; set; }

    [Parameter]
    public EventCallback<(string trackId, bool enabled)> OnToggle8D { get; set; }

    private ElementReference audioRef;
    private ElementReference progressBarRef;
    private IJSObjectReference? audioModule;

    private bool isEqExpanded = false;

    private bool isPlaying = false;
    private bool isComparing = false;

    private double progress = 0;
    private double currentTime = 0;
    private double duration = 0;
    private DotNetObjectReference<TrackItem>? dotNetRef;

    private string audioElementId => $"audio-{Track.Id}";

    private string activeUrl => (Track.Status == TrackStatus.Completed && !string.IsNullOrEmpty(Track.ProcessedDataUrl) && !isComparing)
        ? Track.ProcessedDataUrl
        : Track.FileDataUrl;

    private string? _lastActiveUrl;

    private bool IsConfigurable() => Track.Status == TrackStatus.Pending || Track.Status == TrackStatus.Completed;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Import audio player module
                audioModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/audioPlayer.js");

                // Create .NET reference for JS callbacks
                dotNetRef = DotNetObjectReference.Create(this);

                // Load audio duration if completed
                if (Track.Status == TrackStatus.Completed && Track.Duration > 0)
                {
                    duration = Track.Duration;
                }

                _lastActiveUrl = activeUrl;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading audio module: {ex.Message}");
            }
        }
        else
        {
            // If source switched (e.g., Compare toggle), restart interval tracking if currently playing
            if (_lastActiveUrl != activeUrl)
            {
                _lastActiveUrl = activeUrl;

                if (audioModule != null)
                {
                    try
                    {
                        await audioModule.InvokeVoidAsync("stopProgressInterval", audioRef);
                    }
                    catch { }
                }

                if (isPlaying && audioModule != null && dotNetRef != null)
                {
                    try
                    {
                        await audioModule.InvokeVoidAsync("startProgressInterval", audioRef, dotNetRef);
                    }
                    catch { }
                }
            }
        }
    }

    private async Task TogglePlay()
    {
        if (string.IsNullOrEmpty(activeUrl) || audioModule == null || dotNetRef == null) return;

        try
        {
            if (isPlaying)
            {
                await audioModule.InvokeVoidAsync("pauseAudio", audioRef);
                await audioModule.InvokeVoidAsync("stopProgressInterval", audioRef);
                isPlaying = false;
            }
            else
            {
                await audioModule.InvokeVoidAsync("playAudio", audioRef);
                await audioModule.InvokeVoidAsync("startProgressInterval", audioRef, dotNetRef);
                isPlaying = true;
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Play error: {ex.Message}");
            isPlaying = false;

            // Ensure interval is stopped on error
            try
            {
                if (audioModule != null)
                {
                    await audioModule.InvokeVoidAsync("stopProgressInterval", audioRef);
                }
            }
            catch { }
        }
    }

    [JSInvokable]
    public void UpdateProgressFromJS(double currentTimeValue, double durationValue)
    {
        currentTime = currentTimeValue;
        duration = durationValue;

        if (duration > 0)
        {
            progress = (currentTime / duration) * 100;
        }

        InvokeAsync(StateHasChanged);
    }

    private async void OnLoadedMetadata()
    {
        // Metadata loaded, duration should be available
        await InvokeAsync(async () =>
        {
            if (audioModule != null)
            {
                var audio = await audioModule.InvokeAsync<AudioState>("getAudioState", audioRef);
                duration = audio.Duration;
                StateHasChanged();
            }
        });
    }

    private async void OnLoadedData()
    {
        // Audio data loaded
        await InvokeAsync(async () =>
        {
            if (audioModule != null && duration <= 0)
            {
                var audio = await audioModule.InvokeAsync<AudioState>("getAudioState", audioRef);
                duration = audio.Duration;
                StateHasChanged();
            }
        });
    }

    private async void OnAudioEnded()
    {
        if (audioModule != null)
        {
            await audioModule.InvokeVoidAsync("stopProgressInterval", audioRef);
        }
        isPlaying = false;
        progress = 0;
        currentTime = 0;
        StateHasChanged();
    }

    private async Task HandleSeek(MouseEventArgs e)
    {
        if (duration <= 0 || audioModule == null) return;

        try
        {
            var rect = await audioModule.InvokeAsync<BoundingRect>("getBoundingRect", progressBarRef);

            var x = e.ClientX - rect.Left;
            var percentage = Math.Max(0, Math.Min(100, (x / rect.Width) * 100));
            var newTime = (percentage / 100) * duration;

            await audioModule.InvokeVoidAsync("setCurrentTime", audioRef, newTime);
            progress = percentage;
            currentTime = newTime;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Seek error: {ex.Message}");
        }
    }



    private async Task HandlePresetChanged()
    {
        await OnPresetChange.InvokeAsync((Track.Id, Track.SelectedPresetId));
    }

    private async Task HandleGainInput(int index, ChangeEventArgs e)
    {
        if (double.TryParse(e.Value?.ToString(), out var value))
        {
            await OnGainChange.InvokeAsync((Track.Id, index, value));
        }
    }

    private async Task HandleResetEQ()
    {
        // Update UI immediately for better responsiveness
        var flatPreset = AudioConstants.EQ_PRESETS.FirstOrDefault(p => p.Id == "flat");
        if (flatPreset != null)
        {
            Track.CurrentGains = new List<double>(flatPreset.Gains);
            Track.SelectedPresetId = "flat";
            StateHasChanged();
        }
        await OnPresetChange.InvokeAsync((Track.Id, "flat"));
    }

    private string FormatTime(double seconds)
    {
        if (double.IsNaN(seconds) || seconds <= 0) return "0:00";
        var mins = (int)(seconds / 60);
        var secs = (int)(seconds % 60);
        return $"{mins}:{secs:D2}";
    }

    private string FormatFrequency(int hz)
    {
        return hz >= 1000 ? $"{hz / 1000}k" : hz.ToString();
    }

    private string GetFileExtension()
    {
        return Track.FileType.Split('/').LastOrDefault()?.ToUpper() ?? "AUDIO";
    }

    private string GetDownloadFileName()
    {
        var baseName = System.IO.Path.GetFileNameWithoutExtension(Track.OriginalName);
        var prefix = Track.Is8dEnabled ? "8D" : "EQ";
        return $"{prefix}_{baseName}.wav";
    }

    private string GetCardClasses()
    {
        var baseClasses = "bg-slate-800/80 backdrop-blur-sm rounded-xl border transition-all flex flex-col group overflow-hidden";
        if (isPlaying)
            return $"{baseClasses} border-indigo-500/50 shadow-lg shadow-indigo-500/10";
        return $"{baseClasses} border-slate-700 hover:border-slate-600";
    }

    private string GetPlayButtonClasses()
    {
        var baseClasses = "w-14 h-14 rounded-xl flex items-center justify-center shrink-0 transition-all duration-300";

        if (Track.Status == TrackStatus.Completed && !isComparing)
            return $"{baseClasses} bg-emerald-500 text-white shadow-lg shadow-emerald-500/20 hover:bg-emerald-400";
        else if (isComparing)
            return $"{baseClasses} bg-amber-500 text-white shadow-lg shadow-amber-500/20 hover:bg-amber-400";
        else
            return $"{baseClasses} bg-slate-700 text-slate-300 hover:bg-slate-600";
    }

    private string GetStatusBadgeClasses()
    {
        var baseClasses = "absolute -bottom-2 left-1/2 -translate-x-1/2 px-1.5 py-0.5 rounded text-[10px] font-bold text-white uppercase tracking-wider";
        return $"{baseClasses} {(isComparing ? "bg-amber-600" : "bg-emerald-600")}";
    }

    private string GetTitleClasses()
    {
        var baseClasses = "font-medium text-lg truncate pr-4";
        return $"{baseClasses} {(isPlaying ? "text-white" : "text-slate-200")}";
    }

    private string Get8DToggleClasses()
    {
        var baseClasses = "flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-semibold border transition-all";
        if (Track.Is8dEnabled)
            return $"{baseClasses} bg-pink-500/10 border-pink-500/50 text-pink-400";
        return $"{baseClasses} bg-slate-800 border-slate-700 text-slate-500";
    }

    private string GetEqExpandClasses()
    {
        var baseClasses = "p-1.5 rounded-lg border transition-colors";
        if (isEqExpanded)
            return $"{baseClasses} bg-indigo-600 border-indigo-500 text-white";
        return $"{baseClasses} bg-slate-700 border-slate-600 text-slate-300";
    }

    private string GetCompareButtonClasses()
    {
        var baseClasses = "flex items-center justify-center w-8 h-8 sm:w-auto sm:px-3 sm:py-2 rounded-lg text-xs font-medium transition-all border";
        if (isComparing)
            return $"{baseClasses} bg-amber-500/10 border-amber-500/50 text-amber-400";
        return $"{baseClasses} bg-slate-800 border-slate-700 text-slate-400 hover:text-slate-200";
    }

    private string GetProgressBarClasses()
    {
        return isComparing ? "bg-amber-500" : "bg-emerald-500";
    }




    private string GetSliderBackground(double gain)
    {
        const double min = -20;
        const double range = 40;
        var currentPercent = ((gain - min) / range) * 100;
        var centerPercent = 50.0;
        var trackColor = "#334155";
        var fillColor = "#818cf8";

        // Ensure minimum 2% width for visibility
        var start = Math.Min(currentPercent, centerPercent);
        var end = Math.Max(currentPercent, centerPercent);

        // If start equals end (gain = 0), show small indicator at center
        if (Math.Abs(start - end) < 0.1)
        {
            start = centerPercent - 1;
            end = centerPercent + 1;
        }

        return $"linear-gradient(to right, {trackColor} 0%, {trackColor} {start:F1}%, {fillColor} {start:F1}%, {fillColor} {end:F1}%, {trackColor} {end:F1}%, {trackColor} 100%)";
    }

    private class AudioState
    {
        public double CurrentTime { get; set; }
        public double Duration { get; set; }
    }

    private class BoundingRect
    {
        public double Left { get; set; }
        public double Top { get; set; }
        public double Right { get; set; }
        public double Bottom { get; set; }
        public double Width { get; set; }
        public double Height { get; set; }
        public double X { get; set; }
        public double Y { get; set; }
    }

    public async ValueTask DisposeAsync()
    {
        // Always stop progress tracking first
        if (audioModule != null)
        {
            try
            {
                await audioModule.InvokeVoidAsync("stopProgressInterval", audioRef);
            }
            catch { }
        }

        // Dispose JS module
        if (audioModule != null)
        {
            try
            {
                await audioModule.DisposeAsync();
            }
            catch { }
        }

        // Dispose .NET reference
        dotNetRef?.Dispose();
    }
}
